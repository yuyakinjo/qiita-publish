---
title: CircleCI Orbsã§ã€jobã®çµæœã‚’slackã«é€šçŸ¥ã™ã‚‹
tags:
  - CircleCI
  - Slack
private: false
updated_at: '2020-06-01T10:25:06+09:00'
id: 11f0d778de09502de1f3
organization_url_name: ca-adv
slide: false
---
CircleCIã§jobã®çµæœã‚’é€šçŸ¥ã™ã‚‹:santa:

# TL;DR

- ```CircleCI Orbs```ã‚’ä½¿ç”¨ã—ã¦ç°¡å˜ã«slackã§jobã®çµæœã‚’é€šçŸ¥ã™ã‚‹
- æˆåŠŸã€å¤±æ•—ã‚’IFãªã©ã§æ¡ä»¶åˆ†ã‘ã™ã‚‹å¿…è¦ãªã—
- webhookå–å¾—

 
# ç’°å¢ƒ

```
CircleCI 2.1
orbs: slack: circleci/slack@3.4.2
```

- [Circleci Orbs]([CircleCI Orbsã¨ã¯](https://circleci.com/docs/ja/2.0/orb-intro/))ã¨ã¯

Orbsã¨ã¯ç°¡å˜ã«è¨€ã†ã¨ã€CircleCIã«ç”¨æ„ã•ã‚ŒãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã™([å…¬å¼ CircleCI Orbsã¨ã¯](https://circleci.com/docs/ja/2.0/orb-intro/))
Orbsã‚’ä½¿ç”¨ã™ã‚‹ã¨è¨˜è¿°é‡æ¸›ã‚‹ã—ã€ç°¡å˜ã«CIå®Ÿè£…ã§ãã¾ã™:santa:


# æµã‚Œ

1. webhookå–å¾—
2. circleciã«webhookã‚’è¨­å®š
3. ```.circleci/config.yml```ã‚’è¨­å®š
4. å®Œäº†
5. å¤±æ•—æ™‚ã®ã¿é€šçŸ¥

# 1. webhookå–å¾—

ä¸‹è¨˜URLã‹ã‚‰çµæœã‚’æµã—ãŸã„slackãƒãƒ£ãƒ³ãƒãƒ«ã‚’é¸æŠã—ã¦webhookã‚’å–å¾—

https://slack.com/services/new/incoming-webhook

ã“ã‚“ãªURLãŒå–å¾—ã§ãã‚‹ã¯ãšã§ã™ã®ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãŠãã¾ã—ã‚‡ã†
â†“

```
https://hooks.slack.com/services/hoge/huga
```

# 2. CircleCIã®ç’°å¢ƒå¤‰æ•°ã«webhookã®urlã‚’è¨­å®š

![screenshot 2019-10-24 17.45.34.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/183059/4cb0d154-062d-df32-aae3-b36f904d15bf.png)


CircleCIã®è¨­å®šç”»é¢(æ­¯è»Šâš™ã¿ãŸã„ãªã‚„ã¤)
â†“

ã€ŒEnvironment Variablesã€
â†“
ã€ŒAdd Variableã€ã‚’ãƒãƒğŸ¶
â†“
```SLACK_WEBHOOK```ã¨ã„ã†å¤‰æ•°åã§è¿½åŠ 
â†“
![screenshot 2019-10-24 17.57.26.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/183059/08c4ee48-d078-7136-0620-eee5c5495c2f.png)

å®Ÿéš›ã®å€¤ã¯xxxxã§è¡¨ç¤ºã•ã‚Œã¦ç™»éŒ²å®Œäº†ã—ã¾ã—ãŸ:santa:

# 3. ```.circleci/config.yml```ã‚’è¨­å®š

ãªã«ã¯ã¨ã‚‚ã‚ã‚Œæœ€å°é™ã®ã‚³ãƒ¼ãƒ‰ã‹ã‚‰:santa:

```.circleci/config.yml
version: 2.1

orbs:
  slack: circleci/slack@3.3.0

jobs:
  deploy-and-notify:
    executor: container
    steps:
      - checkout
      - run: ./deploy.sh
      - slack/status:
          success_message: ':circleci-pass: $CIRCLE_BRANCH ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸ\n:github_octocat: Userï¼š$CIRCLE_USERNAME'
          failure_message: ':circleci-fail: $CIRCLE_BRANCH ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¤±æ•—ã—ã¾ã—ãŸ\n:github_octocat: Userï¼š$CIRCLE_USERNAME'
          webhook: '${SLACK_WEBHOOK}'
```

## ãƒã‚¤ãƒ³ãƒˆ
- orbsã‚’æœ€åˆã§å®£è¨€ã¿ãŸã„ã™ã‚‹
- stepsãŒæˆåŠŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹â†’slackã«```success_message```ãŒæµã‚Œã‚‹
- stepsãŒå¤±æ•—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹â†’slackã«```failure_message```ãŒæµã‚Œã‚‹
- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…ã§```:circleci-pass:```ã‚„```:circleci-fail:```ãªã©çµµæ–‡å­—ãŒä½¿ãˆã‚‹


# 4. å®Œäº†

â†“æˆåŠŸæ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã“ã‚“ãªã‹ã‚“ã˜ã§ã™ï¼ˆãƒ¢ã‚¶ã‚¤ã‚¯å¤šãã¦ã”ã‚ã‚“ãªã•ã„ï¼‰
![screenshot 2019-10-24 18.06.03.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/183059/d6a1ff0c-588c-89d8-aecb-066d8c422703.png)

â†“å¤±æ•—æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã“ã‚“ãªã‹ã‚“ã˜ã§ã™ï¼ˆãƒ¢ã‚¶ã‚¤ã‚¯å¤šãã¦ã®ã‚Šå¼ã¿ãŸã„ã§ã”ã‚ã‚“ãªã•ã„ï¼‰
![screenshot 2019-10-24 18.37.18.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/183059/b0f7f465-cb12-0ecb-9659-041fc4b015d1.png)

# å¤±æ•—æ™‚ã®ã¿é€šçŸ¥
é€šçŸ¥ã†ã–ã„ãªãƒ¼ã£ã¦ãªã£ã¦ã€å¤±æ•—æ™‚ã®ã¿é€šçŸ¥ã•ã›ãŸã„ã¨ãã¯ä¸‹è¨˜ã®ã‚ˆã†ã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼è¨­å®šã™ã‚Œã°OKã§ã™

```.circleci/config.yml
orbs:
  slack: circleci/slack@3.4.2

  test:
    executor: container
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run: npm test
      - slack/status:
          fail_only: true #ã“ã‚Œã‚’è¨­å®šã™ã‚‹
          failure_message: ':circleci-fail: ãƒ†ã‚¹ãƒˆå¤±æ•—ã—ã¾ã—ãŸ\n:github_octocat: Userï¼š$CIRCLE_USERNAME'
          webhook: '${SLACK_WEBHOOK}'
```


# ã‚ã¨ãŒã

[circleciã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ä½¿ç”¨ã§ãã‚‹ç’°å¢ƒå¤‰æ•°](https://circleci.com/docs/ja/2.0/env-vars/#%E5%AE%9A%E7%BE%A9%E6%B8%88%E3%81%BF%E7%92%B0%E5%A2%83%E5%A4%89%E6%95%B0)ã‚‚slackã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«çµ„ã¿è¾¼ã‚ã‚‹ã®ã§

- ã©ã®ãƒ–ãƒ©ãƒ³ãƒï¼ˆCIRCLE_BRANCHï¼‰ã‹ã€
- èª°ãŒãƒ—ãƒƒã‚·ãƒ¥ã—ãŸã®ã‹ï¼ˆCIRCLE_USERNAMEï¼‰ãªã©ã‚‚ä½¿ãˆã¦ä¾¿åˆ©ã§ã™ã­ãƒ¼:santa:


Orbsã§ç”¨æ„ã•ã‚Œã¦ã„ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€CircleCIã§ã®è¨˜è¿°é‡ãŒæ¸›ã‚‹ã®ã§Orbsã§ç”¨æ„ã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ã¯ç©æ¥µçš„ã«ä½¿ç”¨ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã—ãŸ:santa:

ä½¿ãˆã‚‹[Orbs ä¸€è¦§](https://circleci.com/orbs/registry/)ã¯ã“ã¡ã‚‰

æ¬¡ã¯ECRã€ECSã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’Orbsä½¿ã£ã¦å®Ÿè£…ã—ãŸè¨˜äº‹ã¯[ã“ã¡ã‚‰](https://qiita.com/k_bobchin/items/83f3c39e9d666a5c1c95)ã§ã™:santa:


# å‚è€ƒ

[CircleCI Orbsã¨ã¯](https://circleci.com/docs/ja/2.0/orb-intro/)
