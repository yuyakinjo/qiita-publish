---
title: CircleCI Orbsã‚’ä½¿ã£ã¦Railsã®ECRãƒ»ECSã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¾¼ã¿ï¼‰ã‚’è‡ªå‹•åŒ–ã—ãŸè©±
tags:
  - Rails
  - CircleCI
  - ECS
  - ECR
  - RunTask
private: false
updated_at: '2019-12-09T11:59:46+09:00'
id: 83f3c39e9d666a5c1c95
organization_url_name: ca-adv
slide: false
---
# TL;DR

- ECS ã® RunTask ã‚’å®Ÿè¡Œã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¾¼ã¿ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒè‡ªå‹•åŒ–ã§ããŸ

# ã„ããªã‚Šã§ã™ãŒ

2 ãƒ¶æœˆå‰ãã‚‰ã„ã¾ã§ä¸‹è¨˜ã®æ‰‹é †ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è¡Œã£ã¦ã„ã¾ã—ãŸ

@ãƒ­ãƒ¼ã‚«ãƒ«

1. ã‚³ãƒ³ãƒ†ãƒŠä½œæˆ (docker build)
2. ã‚³ãƒ³ãƒ†ãƒŠã«ã‚¿ã‚°ã¥ã‘ (docker tag)
3. ECR ã®ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’æ›´æ–° (docker push)
4. AWS ã® RDS ã«ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ (rails db:migrate)
5. AWS ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç”»é¢ã§ ECS ã®æ‰‹å‹•ã§ãƒªãƒ“ã‚¸ãƒ§ãƒ³æ›´æ–°
6. ã‚µãƒ¼ãƒ“ã‚¹ã§ã‚¿ã‚¹ã‚¯å®šç¾©ã®æ›´æ–°
7. æ–°æ—§ã‚¿ã‚¹ã‚¯ãŒå…¥ã‚Œæ›¿ã‚ã‚‹ã®ã‚’è¦‹å®ˆã‚‹

ç¾åœ¨ã¯ãƒ»ãƒ»ãƒ»

1. ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ–ãƒ©ãƒ³ãƒ(production ã‚„ statging)ã«ãƒ—ãƒƒã‚·ãƒ¥
2. slack ã§çµæœã‚’å¾…ã¤

# ä¸€ç•ªã®å£ã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ

å®Ÿã¯ã€ä»Šå›ã®ã“ã®è¨˜äº‹ã§ãŠä¼ãˆã—ãŸã„ã®ã¯å‰è¿°ã®ä¸­ã§ã‚‚ ã€Œ4 ã® RDS ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã€ã®éƒ¨åˆ†ã§ã™:santa:

ãƒ­ãƒ¼ã‚«ãƒ«ã§å®Ÿè¡Œã—ã¦ã„ãŸã“ã‚ã¯ã€è¨±å¯ã•ã‚ŒãŸ IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œã§ãã‚‹ã®ã§ã™ãŒã€

CircleCI ã¯ AWS ã®å¤–éƒ¨ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã¦ã€ã‹ã¤ IP ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒä¸å®šã§ã™ã€‚
ãã‚Œæ•…ã€è¨±å¯ã•ã‚Œã¦ã„ãªã„ IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã§å®Ÿè¡Œã•ã‚Œã‚‹ CicleCI ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒãƒ³ãƒ‰ã‚’ RDS ãŒå¼¾ã„ã¦ã—ã¾ã„ã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡ŒãŒã§ãã¾ã›ã‚“:santa:

# Run Task ã§ä¹—ã‚Šè¶Šãˆã¾ã—ã‚‡

ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å‰ã« ECR ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸæœ€æ–°ã® schema ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒã£ãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã—ã¦[ECS ã® RunTask](https://docs.aws.amazon.com/cli/latest/reference/ecs/run-task.html)ã‚’è¡Œã†ã“ã¨ã§ã€
AWS å†…ã§ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œã‚’è¡Œãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸ:santa:

ã“ã‚Œã§å®Ÿè¡Œå…ƒã® IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯è€ƒãˆãªãã¦ã‚‚ã‚ˆããªã‚Šã¾ã™:santa:

Run Task ã¯ã€AWS å†…ã® ECR ã‹ã‚‰ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã—ã¦ã€docker run ã™ã‚‹ã‚ˆã†ãªå‹•ãã«ãªã‚Šã¾ã™:santa:

```
ç¾åœ¨å‹•ã„ã¦ã„ã‚‹ã‚³ãƒ³ãƒ†ãƒŠã¨ã¯åˆ¥ã«ã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹ãŸã‚ã ã‘ã®ã‚³ãƒ³ãƒ†ãƒŠãŒç«‹ã¡ä¸ŠãŒã‚‹ğŸ“¦

â†“

ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡ŒğŸ³

â†“

ã‚³ãƒ³ãƒ†ãƒŠçµ‚äº†
```

# ãƒã‚¤ãƒ³ãƒˆ

- Run Task å‰ã« ECR ã«æœ€æ–°ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦ã„ã‚‹ã“ã¨(Run Task ã‚’è¡Œã†å‰ã«ã€æœ€æ–°ã® schema ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒã£ã¦ãªã„ã¨ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ»‘ã‚‹)
  â†’ [CircleCI ã® requires](https://circleci.com/docs/ja/2.0/workflows/#%E3%82%B7%E3%83%BC%E3%82%B1%E3%83%B3%E3%82%B7%E3%83%A3%E3%83%AB%E3%82%B8%E3%83%A7%E3%83%96%E3%81%AE%E4%BE%8B)ã§é †ç•ªã‚’æ‹…ä¿
- å®Ÿè¡Œã—ã¦ã‚‚ã‚‰ã„ãŸã„ã‚³ãƒãƒ³ãƒ‰ã‚’ override ã¨ã„ã†å½¢ã§ json ã§æ¸¡ã™
  â†’ AWS CLI ã‚’å®Ÿè¡Œ

# å¯¾è±¡èª­è€…

- CircleCI 2.1 ä»¥ä¸Š
- ECSãƒ»ECR è¨­å®šæ¸ˆã¿
- Rails

# ãƒ¬ã‚·ãƒ”

ã•ã¦ã•ãƒ¼ã¦:santa:

é•·ã„æ–‡è„ˆã§ã¯ã‚ã‚Šã¾ã—ãŸãŒã€ã©ã†ã„ã†ãµã†ã«èª¿ç†ã—ã¦ã„ãã‹æµã‚ŒãŠã•ãˆã¾ã™:santa:

ãƒ‡ãƒ—ãƒ­ã‚¤ã®æ‰‹ä½œæ¥­ã¯ä¸‹è¨˜ã§ã—ãŸ:santa:

1. ã‚³ãƒ³ãƒ†ãƒŠä½œæˆ (docker build)
2. ã‚³ãƒ³ãƒ†ãƒŠã«ã‚¿ã‚°ãšã‘ (docker tag)
3. ECR ã®ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’æ›´æ–° (docker push)
4. AWS ã® RDS ã«ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ (rails db:migrate)
5. AWS ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç”»é¢ã§ ECS ã®æ‰‹å‹•ã§ãƒªãƒ“ã‚¸ãƒ§ãƒ³æ›´æ–°
6. ã‚µãƒ¼ãƒ“ã‚¹ã§ã‚¿ã‚¹ã‚¯å®šç¾©ã®æ›´æ–°
7. æ–°æ—§ã‚¿ã‚¹ã‚¯ãŒå…¥ã‚Œæ›¿ã‚ã‚‹ã®ã‚’è¦‹å®ˆã‚‹

## ä¸Šè¨˜ã«åŠ ãˆã€ã€Œ8. çµæœã‚’ slack é€šçŸ¥ã€ã‚‚åŠ ãˆã¾ã™:santa:

AWS ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«è¦‹å®ˆã‚‹æ‰‹é–“çœãå—å‹•çš„ã«å¯¾å‡¦ã™ã‚‹ãŸã‚ã§ã™ã­:santa:

## CircleCI ã® Orbs ã§ç½®ãæ›ãˆã‚‹ã¨

- 1 ~ 3 â†’ CircleiCI Orbs ã®[aws-ecr/build-and-push-image](https://circleci.com/orbs/registry/orb/circleci/aws-ecr#commands-build-and-push-image)ã‚’ä½¿ç”¨
- 4 â†’ CircleiCI Orbs ã®[aws-cli/setup](https://circleci.com/orbs/registry/orb/circleci/aws-cli#commands-setup)ã‚’ä½¿ç”¨
- 5 ~ 7 â†’ CircleiCI Orbs ã®[aws-cli/install](https://circleci.com/orbs/registry/orb/circleci/aws-cli#commands-install)ã€[aws-cli/setup](https://circleci.com/orbs/registry/orb/circleci/aws-cli#commands-setup)ã€[aws-ecs/update-service](https://circleci.com/orbs/registry/orb/circleci/aws-ecs#commands-update-service)ã‚’ä½¿ç”¨
- 8 â†’ CircleiCI Orbs ã®[slack/status](https://circleci.com/orbs/registry/orb/circleci/slack#usage-status)ä½¿ç”¨

Orbs ã ã‘ã§ã„ã‘ãã†ã§ã™ã­:santa:

Orbs ã‚’é–‹ç™ºã—ã¦ãã‚Œã¦ã„ã‚‹æ–¹ã€…ã€æœ¬å½“ã«æ„Ÿè¬ã§ã™:santa:

### 1 ~ 3 â†’ CircleiCI Orbs ã®[aws-ecr/build-and-push-image](https://circleci.com/orbs/registry/orb/circleci/aws-ecr#commands-build-and-push-image)ã‚’ä½¿ç”¨

config.yml ã¯ä¸‹è¨˜ã®ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸ:santa:

ã‚ãã¾ã§è‡ªåˆ†ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆã§ã™:santa:
å¿…é ˆãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã¯[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://circleci.com/orbs/registry/orb/circleci/aws-ecr#commands-build-and-push-image)ã‚’ã¿ã¦ãã ã•ã„ã€œ

```.circleci/config.yml
version: 2.1

orbs:
  aws-ecr: circleci/aws-ecr@6.2.0

executors:
  (çœç•¥)

jobs:
  build-image-and-push:
    executor: container
    parameters:
      env:
        type: enum
        enum: ['stg', 'prod']
    steps:
      - aws-ecr/build-and-push-image:
          aws-access-key-id: AWS_ACCESS_KEY_ID
          aws-secret-access-key: AWS_SECRET_ACCESS_KEY
          region: AWS_REGION
          repo: '${AWS_RESOURCE_NAME_PREFIX}-<< parameters.env >>'
          extra-build-args: --target apps
          attach-workspace: true
          setup-remote-docker: true

```

Orbs ä½¿ã£ã¦ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼æ¸¡ã—ãŸã ã‘ã§çµ‚ã‚ã£ã¦ã—ã¾ã„ã¾ã—ãŸ:santa:

#### ãƒã‚¤ãƒ³ãƒˆ

- Orbs ä½¿ã£ã¦ã„ã‚‹ã‹ã©ã†ã‹ã¯ã€Orbs ã® key åã¨ã€steps ã§`aws-ecr/build-and-push-image`ã§ã€ã©ã® job ã‚’å‚ç…§ã—ã¦ã„ã‚‹ã‹ãŒã‚ã‹ã‚Šã¾ã™:santa:

- [parameters](https://circleci.com/docs/ja/2.0/reusing-config/#parameters-%E5%AE%A3%E8%A8%80%E3%81%AE%E4%BD%BF%E7%94%A8) ã§ env ã‚’è¨­å®š

parameters ã‚’ä½¿ã†æ„å›³ã¨ã—ã¦ã¯ã€prodction â†’ æœ¬ç•ªç’°å¢ƒã€staging â†’ ãƒ†ã‚¹ãƒˆç’°å¢ƒã§åŒã˜ job ã‚’å®šç¾©ã—ãŸã„ã‘ã©ã€é•ã„ãŒã€AWS ã® ECR ã®ãƒªãƒã‚¸ãƒˆãƒªåã—ã‹ãªã„æ™‚ã«ã€ã‚³ãƒ³ãƒ•ã‚£ã‚°ã‚’å†åˆ©ç”¨ã§ãã‚‹ã®ã§ä¾¿åˆ©ã§ã™:santa:

##### ä¾‹ï¼šparameters ã‚’ä½¿ã‚ãªã„æ™‚

`repo`ã®é•ã„ã ã‘ãªã®ã«ã€2 å€å®šç¾©ã—ãªã„ã¨ã„ã‘ãªã„

```.circleci/config.yml
jobs:
  build-prod-image-and-push:
    executor: container
    steps:
      - aws-ecr/build-and-push-image:
          aws-access-key-id: AWS_ACCESS_KEY_ID
          aws-secret-access-key: AWS_SECRET_ACCESS_KEY
          region: AWS_REGION
          repo: '${AWS_RESOURCE_NAME_PREFIX}-prod'
          extra-build-args: --target apps
          attach-workspace: true
          setup-remote-docker: true

  build-stg-image-and-push:
    executor: container
    steps:
      - aws-ecr/build-and-push-image:
          aws-access-key-id: AWS_ACCESS_KEY_ID
          aws-secret-access-key: AWS_SECRET_ACCESS_KEY
          region: AWS_REGION
          repo: '${AWS_RESOURCE_NAME_PREFIX}-stg'
          extra-build-args: --target apps
          attach-workspace: true
          setup-remote-docker: true
```

##### ä¾‹ï¼šparameters ã‚’ä½¿ã†ã¨ â†“

config ã‚’å†åˆ©ç”¨ã§ãã¾ã™ã­:santa:

```.circleci/config.yml
jobs:
  build-image-and-push:
    executor: container
    parameters:
      env:
        type: enum
        enum: ['stg', 'prod']
    steps:
      - aws-ecr/build-and-push-image:
          aws-access-key-id: AWS_ACCESS_KEY_ID
          aws-secret-access-key: AWS_SECRET_ACCESS_KEY
          region: AWS_REGION
          repo: '${AWS_RESOURCE_NAME_PREFIX}-<< parameters.env >>'
          extra-build-args: --target apps
          attach-workspace: true
          setup-remote-docker: true

```

- å¿…è¦ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼(AWS_ACCESS_KEY_ID ãªã©)ã¯ã€CircleCI ã‹ã‚‰è¨­å®šã—ãŸç’°å¢ƒå¤‰æ•°ã‹ã‚‰æ¸¡ã—ã¦ã„ã‚‹ã ã‘ã§ã™ã­:santa:

CircleCI ã§ã®ç’°å¢ƒå¤‰æ•°ã®è¨­å®šã¯[ã“ã¡ã‚‰](https://circleci.com/docs/ja/2.0/env-vars/)

- [docker ã® multi stage build](https://docs.docker.com/develop/develop-images/multistage-build/)ã§ã‚‚å¤§ä¸ˆå¤«
  `extra-build-args`ã§ docker ã‚³ãƒãƒ³ãƒ‰ã«å¼•æ•°ã‚’æ¸¡ã›ã‚‹ã®ã§å¯¾è±¡ã® layer ã ã‘ã®ãƒ“ãƒ«ãƒ‰ã‚‚å¯èƒ½ã§ã™ã­:santa:

ã€œã€œã€œä½™è«‡ã€œã€œã€œ

multi stage build ã¯ã€ã‚³ãƒ³ãƒ†ãƒŠã‚’å°ã•ãã™ã‚‹æ‰‹æ®µã§ã‚‚ã‚ã‚Šã€æœ€è¿‘ç™ºè¡¨ã•ã‚ŒãŸ[[ãƒ¬ãƒãƒ¼ãƒˆ] ã‚³ãƒ³ãƒ†ãƒŠãŠã‚ˆã³ Kubernetes ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ãƒˆãƒƒãƒ— 5 #reinvent #CON307](https://dev.classmethod.jp/cloud/aws/reinvent2019-container-best-practices/)ã«ã‚‚è¼‰ã£ã¦ã„ã¾ã—ãŸã­:santa:

### 4 â†’ CircleiCI Orbs ã®[aws-cli/setup](https://circleci.com/orbs/registry/orb/circleci/aws-cli#commands-setup)ã‚’ä½¿ç”¨

```.circleci/config.yml
orbs:
  aws-cli: circleci/aws-cli@0.1.16

jobs:
  db-migrate-on-task-run:
    executor: container
    parameters:
      env:
        type: enum
        enum: ['stg', 'prod']
    steps:
      - checkout
      - aws-cli/setup:
          aws-access-key-id: AWS_ACCESS_KEY_ID
          aws-secret-access-key: AWS_SECRET_ACCESS_KEY
          aws-region: AWS_REGION
      - run:
          name: "db migrate"
          command: |
            aws ecs run-task --region $AWS_REGION \
              --cluster hoge-<< parameters.env >> \
              --task-definition hoge-service-<< parameters.env >> \
              --overrides file://docker/run_task_db_migrate_<< parameters.env >>.json
```

Rails ã®ãƒ•ã‚©ãƒ«ãƒ€ã«ã¯ã€RunTask ã«å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ãŒå…¥ã£ã¦ãŠã‚Šã¾ã™:santa:

```
docker
â”œâ”€â”€ run_task_db_migrate_prod.json
â””â”€â”€ run_task_db_migrate_stg.json
```

name ã¯ container åãŒå…¥ã‚Šã€ãã‚ŒãŒç’°å¢ƒé•ã„ã§ç”¨æ„ã•ã‚Œã¦ã„ã‚‹ã ã‘ã§ã™ã­:santa:

```run_task_db_migrate_prod.json
{
  "containerOverrides": [
    {
      "name": "hoge-prod",
      "command": ["rails", "db:migrate"]
    }
  ]
}
```

```run_task_db_migrate_stg.json
{
  "containerOverrides": [
    {
      "name": "hoge-stg",
      "command": ["rails", "db:migrate"]
    }
  ]
}
```

#### ãƒã‚¤ãƒ³ãƒˆ

- aws-cli ã‚³ãƒãƒ³ãƒ‰ã§ run task ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã€aws-cli ã®ã‚»ãƒƒãƒ†ã‚£ãƒ³ã‚°ã‚’ã™ã‚‹

[ECS ã® Orbs](https://circleci.com/orbs/registry/orb/circleci/aws-ecs)ã§ã‚‚ run-task å®Ÿè¡Œã§ããã†ã§ã™ã­ï¼
ã“ã‚Œå®Ÿè£…ã—ã¦æ¤œè¨¼ã—ã¦ãŸæ™‚ã¯ãªã‹ã£ãŸã®ã§ã€åŒã˜ Orbs ã§ã‚‚ã§ãã‚‹å†…å®¹ãŒåºƒãŒã£ã¦ã¾ã™ã­ï¼

ã§ãã¦ã—ã¾ãˆã°ã€ã‚ã£ã•ã‚Šã§ã™ã­:santa:

### 5 ~ 8 â†’ CircleiCI Orbs ã®[aws-cli/install](https://circleci.com/orbs/registry/orb/circleci/aws-cli#commands-install)ã€[aws-cli/setup](https://circleci.com/orbs/registry/orb/circleci/aws-cli#commands-setup)ã€[aws-ecs/update-service](https://circleci.com/orbs/registry/orb/circleci/aws-ecs#commands-update-service)ã€[slack/status](https://circleci.com/orbs/registry/orb/circleci/slack#usage-status)ã‚’ä½¿ç”¨

```.circleci/config.yml
orbs:
  aws-ecs: circleci/aws-ecs@0.0.11
  aws-cli: circleci/aws-cli@0.1.16
  slack: circleci/slack@3.3.0

  service-update-and-notify:
    executor: container
    parameters:
      env:
        type: enum
        enum: ['stg', 'prod']
    steps:
      - checkout
      - aws-cli/install
      - aws-cli/setup:
          aws-access-key-id: AWS_ACCESS_KEY_ID
          aws-secret-access-key: AWS_SECRET_ACCESS_KEY
          aws-region: AWS_REGION
      - aws-ecs/update-service:
          family: hoge-apps-service-<< parameters.env >>
          cluster-name: hoge-<< parameters.env >>
          container-image-name-updates: 'container=hoge-<< parameters.env >>,tag=latest'
          verify-revision-is-deployed: true
          max-poll-attempts: 300
          poll-interval: 10
      - slack/status:
          success_message: ':circleci-pass: $CIRCLE_BRANCH ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸ\n:github_octocat: Userï¼š$CIRCLE_USERNAME'
          failure_message: ':circleci-fail: $CIRCLE_BRANCH ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¤±æ•—ã—ã¾ã—ãŸ\n:github_octocat: Userï¼š$CIRCLE_USERNAME'
          webhook: '${SLACK_WEBHOOK}'
```

- `max-poll-attempts`ã¨`poll-interval`ã§æ–°æ—§è¦‹å®ˆã‚Šã—ãªãã¦ã„ã„ã£ã™ã­

300 ç§’é–“ã€10 ç§’ã« 1 å›åˆ‡ã‚Šæ›¿ã‚ã£ãŸã‹ã­ãƒ¼ï¼Ÿ:santa:

ã£ã¦ã€èã„ã¦ã„ã‚‹å‡¦ç†ã—ã¦ãã‚Œã¦ã‚‹èªè­˜ã§ã™:santa:

shell ã¨ã‹ã§å®Ÿè£…ã—ã¦ã„ã‚‹ä¾‹ã¨ã‹ã‚ã‚Šã¾ã™ãŒã€ã“ã‚Œã ã‘ã§ OK ã§ã™ã­:santa:

- çµæœã¯ slack ã§

steps ã®`aws-ecs/update-service`ãŒæˆåŠŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã ã¨`success_message`ã€ãƒ€ãƒ¡ã ã¨`failure_message`ãŒæµã‚Œã¾ã™:santa:

ãƒ‡ãƒ—ãƒ­ã‚¤ãŒã†ã¾ãã„ã‹ãªã„ç†ç”±ã¯ã„ã‚ã„ã‚ã‚ã‚Šã¾ã™ãŒã€è¦‹å®ˆã‚Šæ™‚é–“å†…ã«ãƒ‡ãƒ—ãƒ­ã‚¤çµ‚ã‚ã‚‰ãªã‹ã£ãŸã®ãŒã»ã¨ã‚“ã©ã§ã™:santa:

ã“ã® slack ã® Orbs ã®ã„ã„ã¨ã“ã‚ã¯ã€çµæœã‚’æ¡ä»¶åˆ†å²ã‚’ã™ã‚‹å¿…è¦ãŒãªã„ã¨ã“ã‚ãŒã‚·ãƒ³ãƒ—ãƒ«ã§ã„ã„ã§ã™ã­:santa:

ç´°ã‹ã„è¨­å®šæ–¹æ³•ã«ã¤ã„ã¦ã¯[ã“ã¡ã‚‰](https://qiita.com/k_bobchin/items/11f0d778de09502de1f3)

### ã“ã‚Œã‚‰ã‚’ workflow ã§æµã‚Œã‚’å®šç¾©

```.circleci/config.yml
workflows:
  db-migrate-and-deploy-to-stg:
    jobs:
      - build-image-and-push:
          env: stg
          filters:
            branches:
              only: staging
      - db-migrate-on-task-run:
          requires:
            - build-image-and-push
          env: stg
          filters:
            branches:
              only: staging
      - service-update-and-notify:
          requires:
            - db-migrate-on-task-run
          env: stg
          filters:
            branches:
              only: staging

  db-migrate-and-deploy-to-prod:
    jobs:
      - build-image-and-push:
          env: prod
          filters:
            branches:
              only: production
      - db-migrate-on-task-run:
          requires:
            - build-image-and-push
          env: prod
          filters:
            branches:
              only: production
      - service-update-and-notify:
          requires:
            - db-migrate-on-task-run
          env: prod
          filters:
            branches:
              only: production
```

#### ãƒã‚¤ãƒ³ãƒˆ

- æµã‚Œã¯ã‚ãã¾ã§ã€[workflow](https://circleci.com/docs/ja/2.0/workflows/)ã§
- filters ã§å¯¾è±¡ãƒ–ãƒ©ãƒ³ãƒçµã‚‹
- å®Ÿè¡Œã®é †ç•ªã¯[requires](https://circleci.com/docs/ja/2.0/workflows/#%E3%82%B7%E3%83%BC%E3%82%B1%E3%83%B3%E3%82%B7%E3%83%A3%E3%83%AB%E3%82%B8%E3%83%A7%E3%83%96%E3%81%AE%E4%BE%8B)ã§åˆ¶å¾¡

ä¾‹ãˆã°ã€staging ã« push ãŒèµ°ã‚‹ã¨

1. build-image-and-push
2. db-migrate-on-task-run
3. service-update-and-notify

ã®é †ç•ªã§ job ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ãã¾ã™:santa:

ã€ç›´åˆ—å®Ÿè¡Œã‚¤ãƒ¡ãƒ¼ã‚¸å›³ã€‘
![screenshot 2019-12-06 14.18.05.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/183059/79436602-0225-b2c0-fc43-9176d930fac6.png)


requires å®šç¾©ã—ãªã„ã¨ã€ã™ã¹ã¦ã® job ãŒä¸¦åˆ—ã§å®Ÿè¡Œã•ã‚Œã¾ã™:santa:

ã€ä¸¦åˆ—å®Ÿè¡Œã‚¤ãƒ¡ãƒ¼ã‚¸å›³ã€‘
![screenshot 2019-12-06 14.18.11.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/183059/2b9c3f01-6d14-3a03-5d25-38989674d9d1.png)

[ã‚¤ãƒ¡ãƒ¼ã‚¸ã®å‚ç…§å…ƒ](https://circleci.com/docs/ja/2.0/workflows/#%E3%82%B7%E3%83%BC%E3%82%B1%E3%83%B3%E3%82%B7%E3%83%A3%E3%83%AB%E3%82%B8%E3%83%A7%E3%83%96%E3%81%AE%E4%BE%8B)

# å‚è€ƒ

- [ECS RunTask](https://docs.aws.amazon.com/cli/latest/reference/ecs/run-task.html)
- [CircleCI Orbs](https://circleci.com/docs/ja/2.0/orb-intro/)
- [CircleCI Workflow](https://circleci.com/docs/ja/2.0/workflows/)
- [[ãƒ¬ãƒãƒ¼ãƒˆ] ã‚³ãƒ³ãƒ†ãƒŠãŠã‚ˆã³ Kubernetes ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ãƒˆãƒƒãƒ— 5 #reinvent #CON307](https://dev.classmethod.jp/cloud/aws/reinvent2019-container-best-practices/)

# ã‚ã¨ãŒã

CircleCI ã¨ã„ã† AWS ã®å¤–ã§ã‚‚ã€Run Task ãŒã§ãã‚‹ã“ã¨ã§ã€ä¹—ã‚Šè¶Šãˆã‚‰ã‚Œã‚‹å£ãŒã‚ã‚‹ã“ã¨ã‚’çŸ¥ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸ:santa:

ã“ã‚Œã‚’å¿œç”¨ã™ã‚Œã°ã€E2E ãƒ†ã‚¹ãƒˆã¨ã‹å¤–éƒ¨ã‹ã‚‰ DB ã«ã‚¢ã‚¯ã‚»ã‚¹ã‚’æ‹’å¦ã•ã‚Œã‚‹ã‚ˆã†ãªã‚±ãƒ¼ã‚¹ã‚‚
Run Task ã§ E2E ãƒ†ã‚¹ãƒˆã™ã‚‹SPA ã‚³ãƒ³ãƒ†ãƒŠã ã‘ç«‹ã¡ä¸Šã’ã¦ãƒ†ã‚¹ãƒˆå®Ÿè¡ŒãŒã§ããã†ã§ã™ã­:santa:

ã“ã‚Œã‚’ Orbs ãªã—ã§å®Ÿè£…ã™ã‚‹ã“ã¨ã«ãªã£ã¦ã„ãŸã‚‰èƒŒç­‹ã«ç¨²å¦»ãŒèµ°ã‚Šãã†ï¼ˆç™½ç›®ï¼‰

Orbsã®é–‹ç™ºè€…æ§˜ãŸã¡ã€æœ¬å½“ã«ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™:santa:
